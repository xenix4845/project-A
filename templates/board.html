<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>폭염 인명피해 통계 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .navbar {
            background-color: #343a40;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1030;
            height: 56px; /* 명시적으로 높이 지정 */
        }
        .sidebar {
            position: fixed;
            top: 56px; /* 네비게이션 바의 높이와 정확히 일치 */
            bottom: 0;
            left: 0;
            width: 200px;
            background-color: #343a40;
            overflow-y: auto;
            transition: all 0.3s;
            z-index: 1020;
            padding-top: 0; /* 패딩 제거 */
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 56px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .sidebar .nav-link {
            font-weight: 500;
            color: #fff;
            padding: 10px 15px;
        }
        .sidebar .nav-link:hover {
            color: #007bff;
        }
        .main-content {
            margin-left: 200px;
            padding: 56px 20px 20px; /* 상단 패딩을 네비게이션 바 높이와 일치 */
            transition: all 0.3s;
        }
        .card {
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .gauge-chart {
            width: 100%;
            max-width: 150px;
            margin: 0 auto;
        }
        /* 팝업 스타일 */
        .popup {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s ease-out;
        }
        .popup-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            animation: popIn 0.5s cubic-bezier(0.38, 0.1, 0.36, 1.14);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            .sidebar .nav-link span {
                display: none;
            }
            .main-content {
                margin-left: 60px;
            }
        }
        /* 차트 스타일 */
        .chart-container {
            position: relative;
            height: 300px;
        }
        /* 테이블 스타일 */
        .table {
            width: 100%;
            margin-bottom: 1rem;
            color: #212529;
        }
        .table th,
        .table td {
            padding: 0.75rem;
            vertical-align: top;
            border-top: 1px solid #dee2e6;
        }
        .table thead th {
            vertical-align: bottom;
            border-bottom: 2px solid #dee2e6;
        }
        .table tbody + tbody {
            border-top: 2px solid #dee2e6;
        }
        /* 버튼 스타일 */
        .btn {
            display: inline-block;
            font-weight: 400;
            color: #212529;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            background-color: transparent;
            border: 1px solid transparent;
            padding: .375rem .75rem;
            font-size: 1rem;
            line-height: 1.5;
            border-radius: .25rem;
            transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out;
        }
        .btn-primary {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            color: #fff;
            background-color: #0069d9;
            border-color: #0062cc;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0">
        <a class="navbar-brand col-sm-3 col-md-2 mr-0" href="#">폭염 인명피해 통계 대시보드</a>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav class="col-md-2 d-none d-md-block bg-dark sidebar">
                <div class="sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-target="dashboard">
                                <i class="fas fa-home"></i> 대시보드
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-target="regional">
                                <i class="fas fa-map-marked-alt"></i> 지역별 현황
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main role="main" class="col-md-9 ml-sm-auto col-lg-10 px-4 main-content">
                <div id="dashboard" class="content-section">
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    System Information
                                </div>
                                <div class="card-body">
                                    <p><strong>년도:</strong> <span id="year"></span></p>
                                    <p><strong>시도:</strong> <span id="sido"></span></p>
                                    <p><strong>데이터 갱신일:</strong> <span id="updateDate"></span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    총 인명피해
                                </div>
                                <div class="card-body">
                                    <div class="gauge-chart">
                                        <canvas id="totalGauge"></canvas>
                                    </div>
                                    <p class="text-center mt-2"><span id="totalCasualties"></span>명</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    실외 인명피해
                                </div>
                                <div class="card-body">
                                    <div class="gauge-chart">
                                        <canvas id="outdoorGauge"></canvas>
                                    </div>
                                    <p class="text-center mt-2"><span id="outdoorCasualties"></span>명</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header">
                                    실내 인명피해
                                </div>
                                <div class="card-body">
                                    <div class="gauge-chart">
                                        <canvas id="indoorGauge"></canvas>
                                    </div>
                                    <p class="text-center mt-2"><span id="indoorCasualties"></span>명</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    실외 인명피해 상세
                                </div>
                                <div class="card-body">
                                    <canvas id="outdoorChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    실내 인명피해 상세
                                </div>
                                <div class="card-body">
                                    <canvas id="indoorChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    세부 통계
                                </div>
                                <div class="card-body">
                                    <table class="table" id="detailTable">
                                        <!-- 테이블 내용은 JavaScript로 채워집니다 -->
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="regional" class="content-section" style="display: none;">
                    <h2>지역별 현황</h2>
                    <div class="row">
                        <div class="col-md-6">
                            <h3>지역별 인명피해 통계표</h3>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>지역</th>
                                        <th>총 인명피해</th>
                                        <th>실외 인명피해</th>
                                        <th>실내 인명피해</th>
                                    </tr>
                                </thead>
                                <tbody id="regionalStatsTable">
                                    <!-- 데이터는 JavaScript로 동적으로 채워집니다 -->
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h3>지역별 인명피해 그래프</h3>
                            <canvas id="regionalStatsChart"></canvas>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="application/json" id="heatWaveData">
        {{ data|tojson|safe }}
    </script>

    <script>
        // JSON 데이터 파싱
        const heatWaveData = JSON.parse(document.getElementById('heatWaveData').textContent);

        // 전역 변수
        let currentData = heatWaveData;
        let regionalChart = null;

        // 페이지 로드 시 실행
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            updateDashboard(currentData);
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.target.getAttribute('data-target');
                    document.querySelectorAll('.content-section').forEach(section => {
                        section.style.display = 'none';
                    });
                    document.getElementById(targetId).style.display = 'block';
                    if (targetId === 'regional') {
                        updateRegionalStats(currentData);
                    }
                });
            });
        }

        // 대시보드 업데이트
        function updateDashboard(data) {
            updateSystemInfo(data);
            updateCasualtiesInfo(data);
            updateDetailedInfo(data);
            updateRegionalStats(data);
        }

        // 시스템 정보 업데이트
        function updateSystemInfo(data) {
            const nationalData = data.find(item => item.region === '전국' || item.region === '합계');
            document.getElementById('year').textContent = nationalData.year;
            document.getElementById('sido').textContent = "전국";
            document.getElementById('updateDate').textContent = new Date().toLocaleDateString();
        }

        // 인명피해 정보 업데이트
        function updateCasualtiesInfo(data) {
            const nationalData = data.find(item => item.region === '전국' || item.region === '합계');
            const totalCasualties = parseInt(nationalData.total);
            const outdoorCasualties = parseInt(nationalData.outdoor.total);
            const indoorCasualties = parseInt(nationalData.indoor.total);

            document.getElementById('totalCasualties').textContent = totalCasualties;
            document.getElementById('outdoorCasualties').textContent = outdoorCasualties;
            document.getElementById('indoorCasualties').textContent = indoorCasualties;

            updateGaugeCharts(totalCasualties, outdoorCasualties, indoorCasualties);
        }

        // 게이지 차트 업데이트
        function updateGaugeCharts(total, outdoor, indoor) {
            createGaugeChart('totalGauge', total, Math.max(total, 3000));  // 최대값은 적절히 조정 필요
            createGaugeChart('outdoorGauge', outdoor, total);
            createGaugeChart('indoorGauge', indoor, total);
        }

        // 상세 정보 업데이트
        function updateDetailedInfo(data) {
            const nationalData = data.find(item => item.region === '전국' || item.region === '합계');
            updateOutdoorChart(nationalData.outdoor);
            updateIndoorChart(nationalData.indoor);
            updateDetailTable(nationalData);
        }

        // 실외 차트 업데이트
        function updateOutdoorChart(outdoorData) {
            const outdoorChartData = [
                outdoorData.workplace,
                outdoorData.field,
                outdoorData.farmland,
                outdoorData.mountain,
                outdoorData.river,
                outdoorData.road,
                outdoorData.residential,
                outdoorData.other
            ];
            createPieChart('outdoorChart', outdoorChartData, ['작업장', '들판', '농지', '산', '강', '도로', '주거지 주변', '기타']);
        }

        // 실내 차트 업데이트
        function updateIndoorChart(indoorData) {
            const indoorChartData = [
                indoorData.house,
                indoorData.building,
                indoorData.workplace,
                indoorData.greenhouse,
                indoorData.other
            ];
            createPieChart('indoorChart', indoorChartData, ['주택', '건물', '작업장', '온실', '기타']);
        }

        // 세부 통계 테이블 업데이트
        function updateDetailTable(data) {
            const detailTable = document.getElementById('detailTable');
            const tableContent = `
                <tr><td>총계</td><td>${data.total}</td></tr>
                <tr><td>실외 총계</td><td>${data.outdoor.total}</td></tr>
                <tr><td>실외 작업장</td><td>${data.outdoor.workplace}</td></tr>
                <tr><td>실외 들판</td><td>${data.outdoor.field}</td></tr>
                <tr><td>실외 농지</td><td>${data.outdoor.farmland}</td></tr>
                <tr><td>실외 산</td><td>${data.outdoor.mountain}</td></tr>
                <tr><td>실외 강</td><td>${data.outdoor.river}</td></tr>
                <tr><td>실외 도로</td><td>${data.outdoor.road}</td></tr>
                <tr><td>실외 주거지 주변</td><td>${data.outdoor.residential}</td></tr>
                <tr><td>실외 기타</td><td>${data.outdoor.other}</td></tr>
                <tr><td>실내 총계</td><td>${data.indoor.total}</td></tr>
                <tr><td>실내 주택</td><td>${data.indoor.house}</td></tr>
                <tr><td>실내 건물</td><td>${data.indoor.building}</td></tr>
                <tr><td>실내 작업장</td><td>${data.indoor.workplace}</td></tr>
                <tr><td>실내 온실</td><td>${data.indoor.greenhouse}</td></tr>
                <tr><td>실내 기타</td><td>${data.indoor.other}</td></tr>
            `;
            detailTable.innerHTML = tableContent;
        }

        // 지역별 통계 업데이트
        function updateRegionalStats(data) {
            const tableBody = document.getElementById('regionalStatsTable');
            tableBody.innerHTML = ''; // 기존 데이터 삭제

            data.forEach(item => {
                if (item.region !== '전국' && item.region !== '합계') {
                    const row = tableBody.insertRow();
                    row.insertCell(0).textContent = item.region;
                    row.insertCell(1).textContent = item.total;
                    row.insertCell(2).textContent = item.outdoor.total;
                    row.insertCell(3).textContent = item.indoor.total;
                }
            });

            updateRegionalChart(data);
        }

        // 지역별 차트 업데이트
        function updateRegionalChart(data) {
            const ctx = document.getElementById('regionalStatsChart').getContext('2d');
            
            if (regionalChart) {
                regionalChart.destroy(); // 기존 차트 제거
            }
            
            const chartData = data.filter(item => item.region !== '전국' && item.region !== '합계');
            
            regionalChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(item => item.region),
                    datasets: [
                        {
                            label: '실외 인명피해',
                            data: chartData.map(item => parseInt(item.outdoor.total)),
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                        },
                        {
                            label: '실내 인명피해',
                            data: chartData.map(item => parseInt(item.indoor.total)),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { stacked: true },
                        y: { 
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '지역별 인명피해 현황'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // 게이지 차트 생성 함수
        function createGaugeChart(elementId, value, max) {
            new Chart(document.getElementById(elementId), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, max - value],
                        backgroundColor: ['#28a745', '#e9ecef']
                    }]
                },
                options: {
                    circumference: 180,
                    rotation: -90,
                    cutout: '80%',
                    plugins: {
                        tooltip: { enabled: false },
                        legend: { display: false }
                    }
                }
            });
        }

        // 파이 차트 생성 함수
        function createPieChart(elementId, data, labels) {
            new Chart(document.getElementById(elementId), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#007bff', '#28a745', '#ffc107', '#dc3545',
                            '#6610f2', '#fd7e14', '#20c997', '#17a2b8'
                        ]
                    }]
                }
            });
        }

        // 팝업 기능
        const popup = document.getElementById('regionPopup');
        const regionSelect = document.getElementById('regionSelect');
        const regionStats = document.getElementById('regionStats');

        // 팝업 열기 (예: 버튼 클릭 시)
        function openPopup() {
            popup.style.display = 'block';
        }

        // 팝업 닫기
        function closePopup() {
            popup.style.display = 'none';
        }

        // 지역 선택 시 통계 표시
        regionSelect.addEventListener('change', function() {
            const selectedRegion = this.value;
            const regionData = currentData.find(item => item.region === selectedRegion);
            
            if (regionData) {
                const statsHtml = `
                    <table class="table">
                        <tr><td>총계</td><td>${regionData.total}</td></tr>
                        <tr><td>실외 총계</td><td>${regionData.outdoor.total}</td></tr>
                        <tr><td>실내 총계</td><td>${regionData.indoor.total}</td></tr>
                    </table>
                `;
                regionStats.innerHTML = statsHtml;
            } else {
                regionStats.innerHTML = "<p>선택된 지역의 데이터가 없습니다.</p>";
            }
        });

        // 팝업 외부 클릭 시 닫기
        window.onclick = function(event) {
            if (event.target == popup) {
                closePopup();
            }
        }
    </script>